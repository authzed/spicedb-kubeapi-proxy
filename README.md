# spicedb-kubeapi-proxy

Runs a proxy in front of kube-apiserver that can authorize requests and filter
responses using an embedded or remote SpiceDB.

# Development

This project uses `mage` to offer various development-related commands.

```bash
# run to get all available commands 
brew install mage
mage
```

## Tests

Runs both unit and e2e tests
```bash
mage test:all
```

## Development environment

```bash
mage dev:up
```

This brings a development kind cluster with the proxy running in it with an embedded SpiceDB.
A development `dev.kubeconfig` file will be generated so that you can configure your client
to talk to either the proxy or the upstream kind cluster.

Examples:

```bash
kubectl --kubeconfig $(pwd)/dev.kubeconfig --context proxy get namespace
```

or

```bash
export KUBECONFIG=$(pwd)/dev.kubeconfig
kubectx proxy
kubectl get namespace
```

You can also talk to the upstream cluster to verify things by switching to the context name `admin`:

```bash
kubectl --kubeconfig $(pwd)/dev.kubeconfig --context admin get namespace
```

To clean everything up just run:

```bash
mage dev:clean
```

## Run the proxy locally

Sometimes you may want to debug the proxy. The easiest way would be to spin up the development environment with `mage dev:up`
and then run the proxy targeting it as upstream:

```bash
mage dev:run
```

Alternatively if you want to run with delve or your IDE, do:

```bash
go run ./cmd/spicedb-kubeapi-proxy/main.go --bind-address=127.0.0.1 --secure-port=8443 --backend-kubeconfig $(pwd)/spicedb-kubeapi-proxy.kubeconfig --client-ca-file $(pwd)/client-ca.crt --requestheader-client-ca-file $(pwd)/client-ca.crt --spicedb-endpoint embedded://
```

You'll then be able to reach out to your local proxy instance with the context `local`. Note TLS certs are
auto-generated by Kube so `--insecure-skip-tls-verify` must be provided.

```bash
export KUBECONFIG=$(pwd)/dev.kubeconfig
kubectx proxy
kubectl --insecure-skip-tls-verify get namespace
```
